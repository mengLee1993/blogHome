<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!--通用-->
    <link rel="stylesheet" href="../../../base/css/trade-base.css">
    <script src="../../../base/js/jquery.js"></script>
    <script src="../../../base/js/public.js"></script>
    <script src="../../../base/js/docassistant.js"></script>
    <script src="../../../base/js/validate.js"></script>
    <script src="../../../base/js/jquery.cookie.js"></script>
    <script src="../../../reqConfig.js"></script>

    <!--插件-->
    <link rel="stylesheet" href="../../../plugin/popup/css/manhuaDialog.1.0_blue.css">
    <script src="../../../plugin/popup/script/manhuaDialog.1.0.js" type="text/javascript"></script>
    <link rel="stylesheet" href="../../../plugin/WdatePickerBlue/My97DatePicker/skin/WdatePicker.css">
    <script src="../../../plugin/WdatePickerBlue/My97DatePicker/WdatePicker.js"></script>
    <link rel="stylesheet" href="../../../plugin/tip/css/tip-twitter/tip-twitter.css">
    <script src="../../../plugin/tip/script/jquery.poshytip.js"></script>


    <!--页面-->
    <style>
        .searchBox-ul{
            width: 100%;
            padding: 20px;
        }
        .searchBox-ul-list{
            width: 30%;
            float: left;
            margin: 10px 10px 10px 0;
            box-sizing: border-box;
        }
        .searchBox-ul-list input{
            float: left;
        }
        .searchBox-ul-list span{
            float: left;
            width: 100px;
        }
        .trade_btn{
            border:1px solid #fff;
            color:#fff;
        }
        .trade_btn:hover{
            background: #000;
            border: 1px solid #fff;
        }
        .trade_btn b{
            color: #fff;
        }
        .popup{
            border: 1px solid #fff;
        }
        .popup ,.popup .content, .popup .title h2{
            background: #000;
            color: #fff;
        }
        .popup .searchBox-ul-list{
            width: 40%;
            float: left;
        }
        .table-listbox{
            height: auto;
        }

    </style>
</head>
<body>
<div id="createBox" class="popup gc_box"   style="display:none">
    <div class="title" style="">
        <h2>详情信息</h2>
        <div>
            <a class="min" href="javascript:" title="最小化" style="display:none;"></a>
            <a class="max" href="javascript:" title="最大化" style="display:none;"></a>
            <a class="revert" href="javascript:" title="还原" style="display:none;"></a>
            <a class="close" href="javascript:" title="关闭" style="display:block;"></a>
        </div>
    </div>
    <div class="content">
        <div class="searchBox">
            <ul class="searchBox-ul clearfix" id="tableListMain">
                <li class="searchBox-ul-list">
                    <span>公司</span>
                    <input id="companyName" type="text" class="trade_input mr10 required" autocomplete="off">
                </li>
                <li class="searchBox-ul-list">
                    <span>入职时间</span>
                    <input id="startTime" class="trade_input mr10 Wdate required" type="text" name="startTime" onclick="WdatePicker({dateFmt:'yyyy-MM-dd',maxDate:'#F{$dp.$D(\'endTime\')}'})" />
                </li>
                <li class="searchBox-ul-list">
                    <span>离职时间</span>
                    <input id="endTime" class="trade_input mr10 Wdate required" type="text" name="endTime" onclick="WdatePicker({dateFmt:'yyyy-MM-dd',minDate:'#F{$dp.$D(\'startTime\')}'})" />
                </li>
                <li class="searchBox-ul-list">
                    <span>工作时长</span>
                    <input id="times" type="text" class="trade_input mr10 required" autocomplete="off">
                </li>
                <li class="searchBox-ul-list fr">
                    <a href="javascript:" class="btn-search trade_btn" id="saveBtn" jsonKey="companyName,startTime,endTime,times">
                        <b>保存</b>
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>


<div id="createChildBox" class="popup gc_box"   style="display:none">
    <div class="title" style="">
        <h2>详情信息</h2>
        <div>
            <a class="min" href="javascript:" title="最小化" style="display:none;"></a>
            <a class="max" href="javascript:" title="最大化" style="display:none;"></a>
            <a class="revert" href="javascript:" title="还原" style="display:none;"></a>
            <a class="close" href="javascript:" title="关闭" style="display:block;"></a>
        </div>
    </div>
    <div class="content">
        <div class="searchBox">
            <ul class="searchBox-ul clearfix" id="tableListChildMain">
                <li class="searchBox-ul-list">
                    <span>项目名称</span>
                    <input id="projectName" type="text" class="trade_input mr10 required" autocomplete="off">
                </li>
                <li class="searchBox-ul-list">
                    <span>项目开始时间</span>
                    <input id="pStartTime" class="trade_input mr10 Wdate required" type="text" name="pStartTime" onclick="WdatePicker({dateFmt:'yyyy-MM-dd',maxDate:'#F{$dp.$D(\'pEndTime\')}'})" />
                </li>
                <li class="searchBox-ul-list">
                    <span>项目结束时间</span>
                    <input id="pEndTime" class="trade_input mr10 Wdate required" type="text" name="pEndTime" onclick="WdatePicker({dateFmt:'yyyy-MM-dd',minDate:'#F{$dp.$D(\'pStartTime\')}'})" />
                </li>
                <li class="searchBox-ul-list">
                    <span>项目时长</span>
                    <input id="times" type="text" class="trade_input mr10 required" autocomplete="off">
                </li>
                <li class="searchBox-ul-list">
                    <span>项目介绍</span>
                    <input id="projectText" type="text" class="trade_input mr10 required" autocomplete="off">
                </li>
                <li class="searchBox-ul-list fr">
                    <a href="javascript:" class="btn-search trade_btn" id="saveChildBtn" jsonKey="projectName,pStartTime,pEndTime,times,projectText">
                        <b>保存</b>
                    </a>
                </li>

            </ul>
        </div>
    </div>
</div>


<div style="width: 100%;box-sizing: border-box;padding: 10px;">
    <h1 style="padding: 10px 0 ;">公司：</h1>
    <div class="searchBox">
        <ul class="searchBox-ul clearfix" id="searchBox">
            <li class="searchBox-ul-list">
                <span>公司</span>
                <input id="companyName" type="text" class="trade_input mr10" autocomplete="off">
            </li>
            <li class="searchBox-ul-list fr">
                <a href="javascript:" class="btn-search trade_btn" id="searchBtn" parentId="searchBox" jsonkey="companyName">
                    <b>搜索</b>
                </a>
                <a href="javascript:" class="btn-search trade_btn" id="addBtn" jsonKey="companyName,startTime,endTime,times">
                    <b>新增</b>
                </a>
                <a href="javascript:" class="btn-search trade_btn" id="delBtn">
                    <b>删除</b>
                </a>
                <a href="javascript:" class="btn-search trade_btn" id="submitBtn">
                    <b>提交页面</b>
                </a>
            </li>
        </ul>
    </div>
    <div id="aDiv" class="table-listbox">
        <table cellspacing="0" cellpadding="0" id="tableList" templateid="templateRow" idx="idx" nodata="noDataCon" class="table-list"  clsChk="clsChk" clsAllChk="clsAllChk" chkId="chkCoding" searchId="searchBtn" addId="addBtn" editAddBoxId="tableListMain" saveId="saveBtn" isCacheCond="sid" style="width: 100%">
            <thead class="table-list-header">
            <tr><th class="table-list-header__th lock-col lock-row" style="width:1%;">
                <input type="checkbox" comType="checkAll" unionTableId="tableList" chkId="chkCoding" class="clsAllChk">
            </th>
                <th class="table-list-header__th lock-row" style="width:2%;">
                    序号
                </th>
                <th class="table-list-header__th lock-row" style="width:12%">公司</th>
                <th class="table-list-header__th lock-row" style="width:10%">入职时间</th>
                <th class="table-list-header__th lock-row" style="width:11%">离职时间</th>
                <th class="table-list-header__th lock-row" style="width:10%">工作时长</th>
                <th class="table-list-header__th lock-row" style="width:10%">操作</th>
            </tr></thead>
            <tbody>
            <tr class="table-list-tr" id="templateRow" style="display: none;">
                <td class="table-list-tr__item lock-col">
                    <div class="w18">
                        <input type="checkbox" id="chkCoding" class="clsChk">
                    </div>
                </td>
                <td class="table-list-tr__item" id="idx"></td>
                <td class="table-list-tr__item" id="companyName"></td>
                <td class="table-list-tr__item" id="startTime"></td>
                <td class="table-list-tr__item" id="endTime"></td>
                <td class="table-list-tr__item" id="times"></td>
                <td class="table-list-tr__item">
                    <a href="javascript:" class="contpro-table__icon contpro-table__icon1" id="editOpe"></a>
                    <!--<a href="javascript:;" class="contpro-table__icon contpro-table__icon3"></a>-->
                </td>
            </tr>
            </tbody>
        </table>
        <div id="noDataCon" class="noDataCon" style="display:none;">
            <i></i>
            <p>暂无数据......</p>
        </div>
    </div>
    <h1 style="padding: 10px 0 ;">项目：</h1>
    <div class="searchBox">
        <ul class="searchBox-ul clearfix" id="searchBoxChild">
            <li class="searchBox-ul-list">
                <span>项目</span>
                <input id="projectName" type="text" class="trade_input mr10" autocomplete="off">
            </li>
            <li class="searchBox-ul-list fr">
                <a href="javascript:" class="btn-search trade_btn" id="searchChildBtn" parentId="searchBoxChild" jsonkey="projectName">
                    <b>搜索</b>
                </a>
                <a href="javascript:" class="btn-search trade_btn" id="addChildBtn" jsonKey="projectName,pStartTime,pEndTime,times,projectText">
                    <b>新增</b>
                </a>
                <a href="javascript:" class="btn-search trade_btn" id="delChildBtn">
                    <b>删除</b>
                </a>
            </li>
        </ul>
    </div>
    <div id="aDiv" class="table-listbox">
        <table cellspacing="0" cellpadding="0" id="tableListChild" templateid="templateRow" idx="idx" nodata="noDataCon2" class="table-list"  clsChk="clsChk" clsAllChk="clsAllChk" chkId="chkCoding"  searchId="searchChildBtn" addId="addChildBtn" editAddBoxId="tableListChildMain" saveId="saveChildBtn" isCacheCond="sid" style="width: 100%">
            <thead class="table-list-header">
            <tr><th class="table-list-header__th lock-col lock-row" style="width:1%;">
                <input type="checkbox" comType="checkAll" unionTableId="tableListChild" chkId="chkCoding" class="clsAllChk">
            </th>
                <th class="table-list-header__th lock-row" style="width:2%;">
                    序号
                </th>
                <th class="table-list-header__th lock-row" style="width:12%">项目名称</th>
                <th class="table-list-header__th lock-row" style="width:10%">项目开始时间</th>
                <th class="table-list-header__th lock-row" style="width:11%">项目结束时间</th>
                <th class="table-list-header__th lock-row" style="width:10%">项目时长</th>
                <!--<th class="table-list-header__th lock-row" style="width:10%">项目链接</th>-->
                <th class="table-list-header__th lock-row" style="width:10%">项目介绍</th>
                <th class="table-list-header__th lock-row" style="width:10%">操作</th>
            </tr></thead>
            <tbody>
            <tr class="table-list-tr" id="templateRow" style="display: none;">
                <td class="table-list-tr__item lock-col">
                    <div class="w18">
                        <input type="checkbox" id="chkCoding" class="clsChk">
                    </div>
                </td>
                <td class="table-list-tr__item" id="idx"></td>
                <td class="table-list-tr__item" id="projectName"></td>
                <td class="table-list-tr__item" id="pStartTime"></td>
                <td class="table-list-tr__item" id="pEndTime"></td>
                <td class="table-list-tr__item" id="times"></td>
                <!--<td class="table-list-tr__item" id="projectUrl"></td>-->
                <td class="table-list-tr__item" id="projectText"></td>
                <td class="table-list-tr__item">
                    <a href="javascript:" class="contpro-table__icon contpro-table__icon1" id="editChildOpe"></a>
                    <!--<a href="javascript:;" class="contpro-table__icon contpro-table__icon3"></a>-->
                </td>
            </tr>
            </tbody>
        </table>
        <div id="noDataCon2" class="noDataCon" style="display:none;">
            <i></i>
            <p>暂无数据......</p>
        </div>
    </div>
</div>



<script>
    var dataMain = dataConfig.workExp.workExp;//主
    var dataChild = [];//子
    var data = null;//$.extend方法中操作的json数据
    var mainClick = null;
    $(function(){
        initplugPath($("#tableList")[0],"standardTableCtrl",{"rspBody":{"resultData":dataMain}});
        initplugPath($("#tableListChild")[0],"standardTableCtrl",{"rspBody":{"resultData":dataChild}});

        //提交页面 修改sessionStorage
        $("#submitBtn").on("click",function(){
            dataConfig.workExp.workExp = dataMain;
            sessionStorage.setItem("dataConfig",JSON.stringify(dataConfig));
            alert("提交数据库成功！");
        });

        //搜索
        $("#searchBtn").on("click",function(){
            var dataSearch = $("#tableList").search();
            initplugPath($("#tableList")[0],"standardTableCtrl",{"rspBody":{"resultData":dataSearch}});
        });

        //新增
        $("#addBtn").on("click",function(){
            openWin('1000', '530', 'createBox', true);
            $("#tableList").add();

        });
        //删除
        $("#delBtn").on("click",function(){
            var cacheArr = $("#tableList")[0].cacheArr ? $("#tableList")[0].cacheArr : [];
            if(cacheArr.length > 0){
                data = JSON.parse(JSON.stringify(dataMain));
                dataMain = $("#tableList").del(cacheArr);
                $("#tableList")[0].cacheArr = [];
                initplugPath($("#tableList")[0],"standardTableCtrl",{"rspBody":{"resultData":data}});
                initplugPath($("#tableListChild")[0],"standardTableCtrl",{"rspBody":{"resultData":[]}});
            }else{
                alert("请勾选数据");
            }

        });
        //保存（新建和编辑）
        $("#saveBtn").on("click",function(){
            initValidate($("#tableListMain")[0]);
            if (!valiClass.validateAll4Ctrl($("#tableListMain")[0])) {
                return false;
            }
            data = JSON.parse(JSON.stringify(dataMain));
            dataMain = $("#tableList").save();
            $("#tableList")[0].cacheArr = [];
            initplugPath($("#tableList")[0],"standardTableCtrl",{"rspBody":{"resultData":dataMain}});
            initplugPath($("#tableListChild")[0],"standardTableCtrl",{"rspBody":{"resultData":[]}});
            closePopupWin();
        });



        /*
        *
        *
        * 子表
        *
        *
        *
        * */
        //搜索
        $("#searchChildBtn").on("click",function(){
            var dataSearch = $("#tableListChild").search();
            initplugPath($("#tableListChild")[0],"standardTableCtrl",{"rspBody":{"resultData":dataSearch}});
        });

        //新增
        $("#addChildBtn").on("click",function(){
            if(!mainClick){
                alert("请选择主表信息");
                return;
            }
            openWin('1000', '530', 'createChildBox', true);
            $("#tableListChild").add();

        });
        //删除
        $("#delChildBtn").on("click",function(){
            if(!mainClick){
                alert("请选择主表信息");
                return;
            }
            var cacheArr = $("#tableListChild")[0].cacheArr ? $("#tableListChild")[0].cacheArr : [];
            if(cacheArr.length > 0){
                data = JSON.parse(JSON.stringify(dataChild));
                dataChild = $("#tableListChild").del(cacheArr);
                $("#tableListChild")[0].cacheArr = [];
                initplugPath($("#tableListChild")[0],"standardTableCtrl",{"rspBody":{"resultData":dataChild}});
                initData(mainClick);
            }else{
                alert("请勾选数据");
            }

        });
        //保存（新建和编辑）
        $("#saveChildBtn").on("click",function(){
            initValidate($("#tableListChildMain")[0]);
            if (!valiClass.validateAll4Ctrl($("#tableListChildMain")[0])) {
                return false;
            }
            data = JSON.parse(JSON.stringify(dataChild));
            dataChild = $("#tableListChild").save();
            $("#tableListChild")[0].cacheArr = [];
            initplugPath($("#tableListChild")[0],"standardTableCtrl",{"rspBody":{"resultData":dataChild}});
            closePopupWin();
            initData(mainClick);
        });
    });

    function clsStandardTableCtrl$progress(jsonItem, cloneRow) {
        if(this.ctrl.id == "tableList"){
            $(cloneRow).on("click",function(){
                if(!jsonItem.children)jsonItem.children=[];
                mainClick = jsonItem.sid;
                dataChild = jsonItem.children;
                initplugPath($("#tableListChild")[0],"standardTableCtrl",{"rspBody":{"resultData":dataChild}});
            });

            //编辑
            $(cloneRow).find("#editOpe").on("click",function(){
                openWin('1000', '530', 'createBox', true);
                $("#tableList").edit(jsonItem);
            });
        }
        if(this.ctrl.id == "tableListChild"){
            //编辑
            $(cloneRow).find("#editChildOpe").on("click",function(){
                openWin('1000', '530', 'createChildBox', true);
                $("#tableListChild").edit(jsonItem);
            });
        }
        if(isChecked(jsonItem,this.cacheArr,"id"))
            $(cloneRow).find("#chkCoding").attr("checked",true);
    }
    function clsStandardTableCtrl$after() {
        if(this.ctrl.id == "tableList"){
            mainClick = null;
        }
        isAllCheck(this.ctrl);
    }

    $.fn.extend({
        add:function(jsonItem){
            var saveId = $(this).attr("saveId");//保存id
            var addId = $(this).attr("addId");//添加id
            var editAddBoxId = $(this).attr("editAddBoxId");//添加按钮的父级id
            //绑定在saveBtn上的主键置唯为空
            $("#" + saveId)[0]._sid = null;
            //获取参数
            var jsonParam = jsonItem ? jsonItem : this.jsonKeyTranslate(addId);
            setValue4Desc(jsonParam,$("#" + editAddBoxId)[0]);
        },
        edit:function(jsonItem){
            var saveId = $(this).attr("saveId");//保存id
            var editAddBoxId = $(this).attr("editAddBoxId");//添加按钮的父级id
            //绑定在saveBtn上的主键置唯为空
            $("#" + saveId)[0]._sid = jsonItem.sid;
            var jsonParam = jsonItem;
            //获取参数
            setValue4Desc(jsonParam,$("#" + editAddBoxId)[0]);
        },
        del:function(delArr){
            if(!delArr || (delArr && delArr.length == 0)){
                return data;
            }
            //循环data，筛选数据
            var jsonSid = {};
            for(var mI = 0 ; mI < delArr.length ; mI++ ){
                jsonSid[delArr[mI].sid] = 1;
            }
            var dataNew = [];
            for(var nI = 0; nI < data.length ; nI++ ){
                var isTrue = true;
                for(var key in jsonSid){
                    if(jsonSid[data[nI]["sid"]]){//如果没有找到，isTrue为false
                        isTrue = false;
                    }
                }
                if(isTrue){
                    dataNew.push(data[nI]);
                }
            }
            return dataNew;
        },
        save:function(jsonItem){
            var saveId = $(this).attr("saveId");//保存id
            var editAddBoxId = $(this).attr("editAddBoxId");//添加按钮的父级id
            //绑定在saveBtn上的主键置唯为空
            var jsonParam = jsonItem ? jsonItem : this.jsonKeyTranslate(saveId);
            //获取参数
            getValue4Desc(jsonParam,$("#" + editAddBoxId)[0]);
            //更新data
            var dataNew = data;
            if(!$("#" + saveId)[0]._sid){//新增
                //添加主键
                jsonParam.sid = this.getMaxSid();
                dataNew.unshift(jsonParam);
            }else{
                jsonParam.sid = $("#" + saveId)[0]._sid;
                for(var nI = 0; nI < dataNew.length ; nI++ ){
                    if(dataNew[nI].sid == $("#" + saveId)[0]._sid){
                        dataNew.splice(nI,1,jsonParam)
                    }
                }
            }

            return dataNew;
        },
        search:function(jsonItem){
            var searchId = $(this).attr("searchId");//搜索id
            var parentId = $("#" + searchId).attr("parentId");//搜索按钮的父级id
            //获取参数
            var jsonParam = jsonItem ? jsonItem : this.jsonKeyTranslate(searchId);
            getValue4Desc(jsonParam,$("#" + parentId)[0]);
            console.log(jsonParam);

            //循环data，筛选数据
            var dataNew = [];
            for(var nI = 0; nI < data.length ; nI++ ){
                var isTrue = true;
                for(var key in jsonParam){
                    if(!data[nI][key] || (data[nI][key] && data[nI][key].indexOf(jsonParam[key]) == -1)){//如果没有找到，isTrue为false
                        isTrue = false;
                    }
                }
                if(isTrue){
                    dataNew.push(data[nI]);
                }
            }
            return dataNew;
        },
        jsonKeyTranslate:function(strId){//将"a,b,c"字符串转变{"a":"","b":"","c":""}
            var jsonKey =  $("#" + strId).attr("jsonKey").split(",");
            var jsonParam = {};
            //获取搜索参数
            for(var nI = 0; nI < jsonKey.length ; nI++ ){
                jsonParam[jsonKey[nI]] = "";
            }
            return jsonParam;
        },
        getMaxSid:function(){//将"001"转变成"002"
            //找到最大sid
            var numMax = 0;//后三位最大值
            var sidMax = "000";//当前最大值的sid
            for(var nI = 0; nI < data.length ; nI++ ){
                var sidCur = data[nI].sid;//当前sid
                var numCur = Number(sidCur.substring(sidCur.length - 3));
                numMax = numMax <= numCur ? numCur : numMax;
                sidMax = numMax <= numCur ? sidCur : sidMax;
            }
            //剪切字符串  "001002003"转换成"001002"
            sidMax = sidMax.split(sidMax.substring(sidMax.length - 3))[0];
            //主键+1
            numMax ++;
            //转成字符串,判断位数，拼接后三位数
            numMax = String(numMax);
            if(numMax.length == 1){
                numMax = "00" + numMax;
            }else if(numMax.length == 2){
                numMax = "0" + numMax;
            }
            sidMax = sidMax + numMax;
            return sidMax;
        }
    });

    //子表变化，主表数据改变
    function initData(sid) {
        for(var nI = 0; nI < dataMain.length; nI++ ){
            if(dataMain[nI].sid == sid){
                dataMain[nI].children = dataChild;
            }
        }
    }


    /*//动态监听全局变量
    var a = { watchValue:0 };
    var lastTimeValue=a.watchValue;
    Object.defineProperty(a, 'watchValue', {
        get: function() {
            console.log('get：' + watchValue);
            return watchValue;
        },
        set: function(value) {
            watchValue = value;
            if(lastTimeValue!=watchValue){
                lastTimeValue=watchValue;
                console.log('value changed!! set: ' + watchValue);
            }
        }
    });*/
</script>
</body>
</html>